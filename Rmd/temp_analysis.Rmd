---
title: "Primary analysis of ADNI 1.5T 3Yr results from Elias"
author: "Thanneer Perumal"
date: "`r date()`"
output: html_document
---

```{r libs, echo=FALSE, warning=FALSE, message=FALSE}
## It is assumed your working directory is where this file
## Load required libraries
library('synapseClient')
library('ggplot2')
library('reshape2')
library('data.table')
library('dplyr')
library('stringr')

synapseLogin()

# source utility files from ../R/lib folder
file.sources = list.files('../R/lib',pattern="*.R")
file.sources = sapply(file.sources,function(x){return(paste('../R/lib',x,sep='/'))})
tmp = sapply(file.sources,source,.GlobalEnv)

options(xtable.type="html")

knitr::opts_chunk$set(
  echo=FALSE,
  warning=FALSE,
  message=FALSE,
  error = FALSE,
  tidy = FALSE)
```

### Data Download
```{r load.data}
adni.mem.1_5T.3Y <- read.csv('./adni.mem_ranked_1.5T_3Yr_takeda_4_6_15.csv')
label.name.conversion <- read.csv('./label_names_conversion.csv')

adni.mem.1_5T.3Y <- mutate(adni.mem.1_5T.3Y, 
                           sig.feature = a.ks.pvals <= 0.05 & a.cor.pvals <= 0.05,
                           feature = sapply(str_split(adni.mem.1_5T.3Y$var.nms,'\\.'),function(x){paste(x[-(length(x))],collapse='.')}),
                           region = sapply(str_split(adni.mem.1_5T.3Y$var.nms,'\\.'),function(x){paste(x[(length(x))],collapse='.')}))
sig.table <- xtabs(sig.feature ~ feature + region,data = adni.mem.1_5T.3Y)
colnames(sig.table) <- label.name.conversion[match(label.name.conversion$Label,colnames(sig.table)),1]

unique.features <- unique(sapply(str_split(rownames(sig.table),'\\.'),function(x){x <- x[x!=""];l <- length(x);ifelse(l>1,paste(x[-(l)],collapse='.'),x)}))

region.ranking <- colSums(sig.table[rownames(sig.table) %in% c('FreeSurfer.thickness..median','mean.curvature..median','Volume','travel.depth..median','FreeSurfer.convexity..sulc...median'),])
region.ranking <- sort(region.ranking,decreasing = T)
region.ranking <- region.ranking[region.ranking!=0]

unique.regions <- unique(sapply(str_split(names(region.ranking),'-'),function(x){x[[length(x)]]}))


```
1. Image features used:
  * FreeSurfer.thickness..median  
  * mean.curvature..median         
  * Volume
  * travel.depth..median  
  * FreeSurfer.convexity..sulc...median
2. Significantly changed regions that are also correlated with ADNI.MEM are: `r unique.regions`

       var.nms   ks.pvals a.ks.pvals   cor.pvals a.cor.pvals delta.median
69 Volume.1016 0.06359879  0.2611341 0.002385378   0.1643734    -101.8777
70 Volume.2016 0.00000000  0.0000000 0.010006541   0.4435857    5082.6141
      obs.cor  r.ks r.cor ave.r sig.feature feature region
69  0.1876072 879.5 474.5   677       FALSE  Volume   1016
70 -0.1594770  16.0 738.0   377       FALSE  Volume   2016


middletemporal  1015 syn3191101
superiortemporal  1030 syn3191103
inferiortemporal  1009 syn3191099
precuneus superior parietal lobule syn3191119
caudalanteriorcingulate  2002 syn3191107

```{r}
# significant FreeSurfer.thickness
sig.FreeSurfer.thickness <- filter(sig.sets,var.nms %in% grep('mean.curvature..mean',sig.sets$var.nms,value=T))
filter(tmp1, Label %in% unique(sapply(str_split(sig.FreeSurfer.thickness$var.nms,'\\.'),function(x){x[[length(x)]]})))

```
